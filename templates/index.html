<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Raspberry Pi Music Player</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .breadcrumb a { text-decoration: none; margin-right: 5px; }
        .folder, .file { margin: 5px 0; }
        .progress-container { margin-top: 20px; }
        #progress { width: 100%; }
        #controls button { margin-right: 10px; }
    </style>
</head>
<body>
    <h1>ðŸŽµ Raspberry Pi Music Player</h1>

    <div>
      <strong>Current:</strong>
      {% for crumb in breadcrumbs %}
        {% if not loop.first %} / {% endif %}
        <a href="{{ crumb.url }}">{{ crumb.name }}</a>
      {% endfor %}
    </div>

    <!-- Breadcrumb -->
    <div class="breadcrumb">
        {% for crumb in breadcrumb %}
            {% if not loop.last %}
                <a href="{{ url_for('browse', path=crumb.path) }}">{{ crumb.name }}</a> /
            {% else %}
                {{ crumb.name }}
            {% endif %}
        {% endfor %}
    </div>

    <!-- Directory listing -->
    <ul>
    {% for item in entries %}
    <li>
        {% if item.is_dir %}
        <a href="{{ item.url }}">{{ item.name }}/</a>
        {% else %}
        {{ item.name }}
        <button onclick="playFile('{{ (path ~ '/' if path else '') ~ item.name }}')">Play</button>
        {% endif %}
    </li>
    {% endfor %}
    </ul>

    <!-- Player controls -->
    <div id="player" class="progress-container">
        <p id="now-playing">Not playing</p>
        <progress id="progress" value="0" max="100"></progress>
        <span id="time"></span>
        <div id="controls">
            <button onclick="stopSong()">Stop</button>
            <button id="pauseResumeBtn" onclick="pauseResume()" disabled>Pause</button>
        </div>
    </div>

    <script>
        async function playFile(relPath) {
          const resp = await fetch("/play", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({file: relPath})
          });
          const data = await resp.json();
          console.log("play response", data);
        }

        async function play(path) {
            await fetch("/play", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ path: path })
            });
        }

        async function stopSong() {
            await fetch("/stop", { method: "POST" });
        }

        async function pauseResume() {
            await fetch("/pause", { method: "POST" });
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return (h > 0 ? h + ":" : "") +
                   (m < 10 ? "0" : "") + m + ":" +
                   (s < 10 ? "0" : "") + s;
        }

        async function updateStatus() {
            const res = await fetch("/status");
            const data = await res.json();

            // Song name
            document.getElementById("now-playing").innerText =
                data.song ? "Now Playing: " + data.song : "Not playing";

            // Progress bar
            if (data.length > 0) {
                const percent = (data.pos / data.length) * 100;
                document.getElementById("progress").value = percent;
                document.getElementById("time").innerText =
                    formatTime(data.pos) + " / " + formatTime(data.length);
            } else {
                document.getElementById("progress").value = 0;
                document.getElementById("time").innerText = "";
            }

            // Buttons
            const pauseBtn = document.getElementById("pauseResumeBtn");
            if (data.state === "Playing") {
                pauseBtn.disabled = false;
                pauseBtn.innerText = "Pause";
            } else if (data.state === "Paused") {
                pauseBtn.disabled = false;
                pauseBtn.innerText = "Resume";
            } else {
                pauseBtn.disabled = true;
                pauseBtn.innerText = "Pause";
            }
        }

        setInterval(updateStatus, 1000);
    </script>
</body>
</html>
